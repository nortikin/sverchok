<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.5">
<title>sverchok.utils.modules.eval_formula API documentation</title>
<meta name="description" content="">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source > summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible;min-width:max-content}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin:1em 0}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
/* Collapse source docstrings */
setTimeout(() => {
[...document.querySelectorAll('.hljs.language-python > .hljs-string')]
.filter(el => el.innerHTML.length > 200 && ['"""', "'''"].includes(el.innerHTML.substring(0, 3)))
.forEach(el => {
let d = document.createElement('details');
d.classList.add('hljs-string');
d.innerHTML = '<summary>"""</summary>' + el.innerHTML.substring(3);
el.replaceWith(d);
});
}, 100);
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>sverchok.utils.modules.eval_formula</code></h1>
</header>
<section id="section-intro">
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="sverchok.utils.modules.eval_formula.get_variables"><code class="name flex">
<span>def <span class="ident">get_variables</span></span>(<span>string)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_variables(string):
    &#34;&#34;&#34;
    Get set of free variables used by formula
    &#34;&#34;&#34;
    string = string.strip()
    if not len(string):
        return set()
    root = ast.parse(string, mode=&#39;eval&#39;)
    visitor = VariableCollector()
    visitor.visit(root)
    result = visitor.variables
    return result.difference(safe_names.keys())</code></pre>
</details>
<div class="desc"><p>Get set of free variables used by formula</p></div>
</dd>
<dt id="sverchok.utils.modules.eval_formula.safe_eval"><code class="name flex">
<span>def <span class="ident">safe_eval</span></span>(<span>string, variables)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def safe_eval(string, variables):
    &#34;&#34;&#34;
    Evaluate expression, allowing only functions known to be &#34;safe&#34;
    to be used.
    &#34;&#34;&#34;
    try:
        env = dict()
        env.update(safe_names)
        env.update(variables)
        env[&#34;__builtins__&#34;] = {}
        root = ast.parse(string, mode=&#39;eval&#39;)
        return eval(compile(root, &#34;&lt;expression&gt;&#34;, &#39;eval&#39;), env)
    except SyntaxError as e:
        logging.exception(e)
        raise Exception(&#34;Invalid expression syntax: &#34; + str(e))</code></pre>
</details>
<div class="desc"><p>Evaluate expression, allowing only functions known to be "safe"
to be used.</p></div>
</dd>
<dt id="sverchok.utils.modules.eval_formula.safe_eval_compiled"><code class="name flex">
<span>def <span class="ident">safe_eval_compiled</span></span>(<span>compiled, variables, allowed_names=None)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def safe_eval_compiled(compiled, variables, allowed_names = None):
    &#34;&#34;&#34;
    Evaluate expression, allowing only functions known to be &#34;safe&#34;
    to be used.
    &#34;&#34;&#34;
    if allowed_names is None:
        allowed_names = safe_names
    try:
        env = dict()
        env.update(allowed_names)
        env.update(variables)
        env[&#34;__builtins__&#34;] = {}
        return eval(compiled, env)
    except SyntaxError as e:
        sv_logging.exception(e)
        raise Exception(&#34;Invalid expression syntax: &#34; + str(e))</code></pre>
</details>
<div class="desc"><p>Evaluate expression, allowing only functions known to be "safe"
to be used.</p></div>
</dd>
<dt id="sverchok.utils.modules.eval_formula.sv_compile"><code class="name flex">
<span>def <span class="ident">sv_compile</span></span>(<span>string)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def sv_compile(string):
    try:
        root = ast.parse(string, mode=&#39;eval&#39;)
        return compile(root, &#34;&lt;expression&gt;&#34;, &#39;eval&#39;)
    except SyntaxError as e:
        logging.exception(e)
        raise Exception(&#34;Invalid expression syntax: &#34; + str(e))</code></pre>
</details>
<div class="desc"></div>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="sverchok.utils.modules.eval_formula.VariableCollector"><code class="flex name class">
<span>class <span class="ident">VariableCollector</span></span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class VariableCollector(ast.NodeVisitor):
    &#34;&#34;&#34;
    Visitor class to collect free variable names from the expression.
    The problem is that one doesn&#39;t just select all names from expression:
    there can be local-only variables.

    For example, in

        [g*g for g in lst]

    only &#34;lst&#34; should be considered as a free variable, &#34;g&#34; should be not,
    as it is bound by list comprehension scope.

    This implementation is not exactly complete (at least, dictionary comprehensions
    are not supported yet). But it works for most cases.

    Please refer to ast.NodeVisitor class documentation for general reference.
    &#34;&#34;&#34;
    def __init__(self):
        self.variables = set()
        # Stack of local variables
        # It is not enough to track just a plain set of names,
        # since one name can be re-introduced in the nested scope
        self.local_vars = []

    def push(self, local_vars):
        self.local_vars.append(local_vars)

    def pop(self):
        return self.local_vars.pop()

    def is_local(self, name):
        &#34;&#34;&#34;
        Check if name is local variable
        &#34;&#34;&#34;

        for stack_frame in self.local_vars:
            if name in stack_frame:
                return True
        return False

    def visit_SetComp(self, node):
        local_vars = set()
        for generator in node.generators:
            if isinstance(generator.target, ast.Name):
                local_vars.add(generator.target.id)
        self.push(local_vars)
        self.generic_visit(node)
        self.pop()

    def visit_ListComp(self, node):
        local_vars = set()
        for generator in node.generators:
            if isinstance(generator.target, ast.Name):
                local_vars.add(generator.target.id)
        self.push(local_vars)
        self.generic_visit(node)
        self.pop()

    def visit_Lambda(self, node):
        local_vars = set()
        arguments = node.args
        for arg in arguments.args:
            local_vars.add(arg.id)
        if arguments.vararg:
            local_vars.add(arguments.vararg.arg)
        self.push(local_vars)
        self.generic_visit(node)
        self.pop()

    def visit_Name(self, node):
        name = node.id
        if not self.is_local(name):
            self.variables.add(name)

        self.generic_visit(node)</code></pre>
</details>
<div class="desc"><p>Visitor class to collect free variable names from the expression.
The problem is that one doesn't just select all names from expression:
there can be local-only variables.</p>
<p>For example, in</p>
<pre><code>[g*g for g in lst]
</code></pre>
<p>only "lst" should be considered as a free variable, "g" should be not,
as it is bound by list comprehension scope.</p>
<p>This implementation is not exactly complete (at least, dictionary comprehensions
are not supported yet). But it works for most cases.</p>
<p>Please refer to ast.NodeVisitor class documentation for general reference.</p></div>
<h3>Ancestors</h3>
<ul class="hlist">
<li>ast.NodeVisitor</li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="sverchok.utils.modules.eval_formula.VariableCollector.is_local"><code class="name flex">
<span>def <span class="ident">is_local</span></span>(<span>self, name)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def is_local(self, name):
    &#34;&#34;&#34;
    Check if name is local variable
    &#34;&#34;&#34;

    for stack_frame in self.local_vars:
        if name in stack_frame:
            return True
    return False</code></pre>
</details>
<div class="desc"><p>Check if name is local variable</p></div>
</dd>
<dt id="sverchok.utils.modules.eval_formula.VariableCollector.pop"><code class="name flex">
<span>def <span class="ident">pop</span></span>(<span>self)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def pop(self):
    return self.local_vars.pop()</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="sverchok.utils.modules.eval_formula.VariableCollector.push"><code class="name flex">
<span>def <span class="ident">push</span></span>(<span>self, local_vars)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def push(self, local_vars):
    self.local_vars.append(local_vars)</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="sverchok.utils.modules.eval_formula.VariableCollector.visit_Lambda"><code class="name flex">
<span>def <span class="ident">visit_Lambda</span></span>(<span>self, node)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visit_Lambda(self, node):
    local_vars = set()
    arguments = node.args
    for arg in arguments.args:
        local_vars.add(arg.id)
    if arguments.vararg:
        local_vars.add(arguments.vararg.arg)
    self.push(local_vars)
    self.generic_visit(node)
    self.pop()</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="sverchok.utils.modules.eval_formula.VariableCollector.visit_ListComp"><code class="name flex">
<span>def <span class="ident">visit_ListComp</span></span>(<span>self, node)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visit_ListComp(self, node):
    local_vars = set()
    for generator in node.generators:
        if isinstance(generator.target, ast.Name):
            local_vars.add(generator.target.id)
    self.push(local_vars)
    self.generic_visit(node)
    self.pop()</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="sverchok.utils.modules.eval_formula.VariableCollector.visit_Name"><code class="name flex">
<span>def <span class="ident">visit_Name</span></span>(<span>self, node)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visit_Name(self, node):
    name = node.id
    if not self.is_local(name):
        self.variables.add(name)

    self.generic_visit(node)</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="sverchok.utils.modules.eval_formula.VariableCollector.visit_SetComp"><code class="name flex">
<span>def <span class="ident">visit_SetComp</span></span>(<span>self, node)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def visit_SetComp(self, node):
    local_vars = set()
    for generator in node.generators:
        if isinstance(generator.target, ast.Name):
            local_vars.add(generator.target.id)
    self.push(local_vars)
    self.generic_visit(node)
    self.pop()</code></pre>
</details>
<div class="desc"></div>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="sverchok.utils.modules" href="index.html">sverchok.utils.modules</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="sverchok.utils.modules.eval_formula.get_variables" href="#sverchok.utils.modules.eval_formula.get_variables">get_variables</a></code></li>
<li><code><a title="sverchok.utils.modules.eval_formula.safe_eval" href="#sverchok.utils.modules.eval_formula.safe_eval">safe_eval</a></code></li>
<li><code><a title="sverchok.utils.modules.eval_formula.safe_eval_compiled" href="#sverchok.utils.modules.eval_formula.safe_eval_compiled">safe_eval_compiled</a></code></li>
<li><code><a title="sverchok.utils.modules.eval_formula.sv_compile" href="#sverchok.utils.modules.eval_formula.sv_compile">sv_compile</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="sverchok.utils.modules.eval_formula.VariableCollector" href="#sverchok.utils.modules.eval_formula.VariableCollector">VariableCollector</a></code></h4>
<ul class="two-column">
<li><code><a title="sverchok.utils.modules.eval_formula.VariableCollector.is_local" href="#sverchok.utils.modules.eval_formula.VariableCollector.is_local">is_local</a></code></li>
<li><code><a title="sverchok.utils.modules.eval_formula.VariableCollector.pop" href="#sverchok.utils.modules.eval_formula.VariableCollector.pop">pop</a></code></li>
<li><code><a title="sverchok.utils.modules.eval_formula.VariableCollector.push" href="#sverchok.utils.modules.eval_formula.VariableCollector.push">push</a></code></li>
<li><code><a title="sverchok.utils.modules.eval_formula.VariableCollector.visit_Lambda" href="#sverchok.utils.modules.eval_formula.VariableCollector.visit_Lambda">visit_Lambda</a></code></li>
<li><code><a title="sverchok.utils.modules.eval_formula.VariableCollector.visit_ListComp" href="#sverchok.utils.modules.eval_formula.VariableCollector.visit_ListComp">visit_ListComp</a></code></li>
<li><code><a title="sverchok.utils.modules.eval_formula.VariableCollector.visit_Name" href="#sverchok.utils.modules.eval_formula.VariableCollector.visit_Name">visit_Name</a></code></li>
<li><code><a title="sverchok.utils.modules.eval_formula.VariableCollector.visit_SetComp" href="#sverchok.utils.modules.eval_formula.VariableCollector.visit_SetComp">visit_SetComp</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.5</a>.</p>
</footer>
</body>
</html>
